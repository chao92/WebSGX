<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <title>ECDH Key generation test page</title>
    <link href="css/bootstrap.min.css" rel="stylesheet">
    <style type="text/css">
        div.result {
            background-color: #cccccc;
            word-wrap: break-word;
        }
        .cyphertext {
            word-wrap: break-word;
        }
    </style>

</head>

<body>

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
    <script src="js/bootstrap.min.js"></script>

    <!-- add AES-CMAC -->
    <script type="text/javascript" src="cryptojs-extension-master/lib/cryptojs-aes.min.js"></script>
    <script type="text/javascript" src="cryptojs-extension-master/build/cmac.min.js"></script>
    <!-- test web crypto  -->
    <script type="text/javascript" src="js/webcrypto.js"></script>
    <script type="text/javascript" src="js/client_main.js"></script>
    <script type="text/javascript" src="js/attestation_client.js"></script>

    <!-- end of web crypto -->
    <script type="text/javascript">
        window.crypto = window.crypto || window.msCrypto; //for IE11
        if (window.crypto.webkitSubtle) {
            window.crypto.subtle = window.crypto.webkitSubtle; //for Safari
        }

        window.crypto.subtle.generateKey({
                name: "ECDH",
                namedCurve: "P-256",
            }, true, ["deriveKey", "deriveBits"])
            .then(function(key) {
                var C_private_key_object = key.privateKey;
                var C_public_key_object = key.publicKey;
                var publicKey_x;
                var publicKey_y;
                var privateKey_x;
                var privateKey_y;
                var privateKey_d;

                window.crypto.subtle.exportKey("jwk", C_public_key_object) //base64url encoding
                    .then(function(key) {
                        console.log(key);
                        console.log("exported public key x");
                        publicKey_x = Base64URL2HEX(key.x);
                        console.log(publicKey_x);
                        publicKey_y = Base64URL2HEX(key.y);
                        console.log(publicKey_y);

                        window.crypto.subtle.exportKey("jwk", C_private_key_object) //base64url encoding
                            .then(function(key) {
                                console.log(key);
                                console.log("exported private key x");
                                privateKey_x = Base64URL2HEX(key.x);
                                console.log(privateKey_x);
                                console.log("exported private key y");
                                privateKey_y = Base64URL2HEX(key.y);
                                console.log(privateKey_y);
                                console.log("exported private key d");
                                privateKey_d = Base64URL2HEX(key.d);
                                console.log(privateKey_d);

                                var ga_x = "955b685a1aa2aa26632745aa5cebeb6d54e82b382276bf856f74767dfe6c3abe";
                                var ga_y = "1c2ac3b5122a502caf32d27d5ed2fc764c9d4b398f9ceabb4014839416297ff3";
                                console.log("AAAA");
                                console.log(publicKey_x);
                                console.log("AAAA");
                                window.crypto.subtle.importKey(
                                        "jwk", //can be "jwk" (public or private), "raw" (public only), "spki" (public only), or "pkcs8" (private only)
                                        { //this is an example jwk key, other key types are Uint8Array objects
                                            kty: "EC",
                                            crv: "P-256",
                                            x: HEX2Base64URL(privateKey_x),
                                            y: HEX2Base64URL(privateKey_y),
                                            // d: "250dDOHq0N-P7fevM9XBfQ9fpICqDgnYk2vX0w8Ci-c",
                                            ext: true,
                                        }, { //these are the algorithm options
                                            name: "ECDH",
                                            namedCurve: "P-256", //can be "P-256", "P-384", or "P-521"
                                        },
                                        false, //whether the key is extractable (i.e. can be used in exportKey)
                                        [] //"deriveKey" and/or "deriveBits" for private keys only (just put an empty list if importing a public key)
                                    )
                                    .then(function(publicKey) {
                                        var imported_public_key = publicKey;
                                        console.log("imported public key");
                                        console.log(imported_public_key);
                                        var gb_x = "98370bbd2b9ad2e890bd2b1016310cd5c396c5a41478779db947904ae7cf142f";
                                        var gb_y = "88ccfea8fee2883b05d45238c227729818fda47646654bd8b243756d96137f6a";
                                        var gb_d = "b92bd50aa1e30bfdaa3ea2aa0fca94ab631fb3aff09cd5f4bbf8d53ede750d5b";

                                        window.crypto.subtle.importKey(
                                                "jwk", //can be "jwk" (public or private), "raw" (public only), "spki" (public only), or "pkcs8" (private only)
                                                { //this is an example jwk key, other key types are Uint8Array objects
                                                    kty: "EC",
                                                    crv: "P-256",
                                                    x: HEX2Base64URL(gb_x),
                                                    y: HEX2Base64URL(gb_y),
                                                    d: HEX2Base64URL(gb_d),
                                                    ext: true,
                                                }, { //these are the algorithm options
                                                    name: "ECDH",
                                                    namedCurve: "P-256", //can be "P-256", "P-384", or "P-521"
                                                },
                                                false, //whether the key is extractable (i.e. can be used in exportKey)
                                                ["deriveKey", "deriveBits"] //"deriveKey" and/or "deriveBits" for private keys only (just put an empty list if importing a public key)
                                            )
                                            .then(function(privateKey) {
                                                var imported_private_key = privateKey;
                                                console.log("imported private key")
                                                console.log(imported_private_key)

                                                // window.crypto.subtle.deriveBits({
                                                //             name: "ECDH",
                                                //             namedCurve: "P-256", //can be "P-256", "P-384", or "P-521"
                                                //             public: imported_public_key, //an ECDH public key from generateKey or importKey
                                                //         },
                                                //         imported_private_key, //your ECDH private key from generateKey or importKey
                                                //         256)
                                                //     .then(function(bits) {
                                                //         console.log("it should be 67037ff5c47c93acccb4b3d0bca7662f436f3ef2393608b3d7bf2c114194c611")
                                                //         console.log("derived shared key is:");
                                                //         dh_shared_key = new Uint8Array(bits);
                                                //         console.log(changeEndian(byteToHexString(dh_shared_key))); // change original endiness to meet the requriement with c++ client
                                                //     }).catch = function(e) {
                                                //         console.log("derived shared key error");
                                                //         console.log(e.message);
                                                //     }


                                            })
                                            .catch = function(e) {
                                                console.log("import private key error");
                                                console.log(e.message);
                                            }

                                    })
                                    .catch = function(e) {
                                        console.log("import public key error");
                                        console.log(e.message);
                                    }



                            }).catch = function(e) {
                                console.log("export private key error");
                                console.log(e.message);
                            }


                    }).catch = function(e) {
                        console.log("export public key error");
                        console.log(e.message);
                    }




            }).catch = function(e) {
                console.log("generate key error");
                console.log(e.message);
            }
    </script>
</body>

</html>