<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <title>Demo page</title>
    <link href="css/bootstrap.min.css" rel="stylesheet">
    <style type="text/css">
        div.result {
            background-color: #cccccc;
            word-wrap: break-word;
        }
        .cyphertext {
            word-wrap: break-word;
        }
    </style>

</head>

<body>
    <div class="container">
        <div class="page-header">
            <h1>Computing Demo <small>Client Attestation</small></h1>
            <p>vk_key: shared secret key for REPORT_DATA
                <br>mk_key: shared secret key for generating MAC's
                <br> sk_key: shared secret key for encryption
                <br>smk_key: used only for SIGMA protocol</p>
        </div>

        <h2>Client</h2>
        <div class="row">
            <div class="col-md-4">
                <button id="A_btn_start_Attestation" class="btn btn-primary">Start Attestation</button>

            </div>
            <div class="col-md-7 col-md-offset-1 result">
                <h3>Input is: </h3>
                <p>username: <span id="client_username" class="ciphertext">user1</span> </p>
                <p>password: <span id="client_password" class="ciphertext">13313</span> </p>
                <p>SSL Setting: <span id="client_password" class="ciphertext">nSSL</span> </p>
                <p>Client Private Key (for signing ga_gb): <span id="client_private key" class="ciphertext">018c03d1533457adeaaeb6653b6a861fec879c4311de663bcea1522dbb6ce790</span> </p>
                <h3>Extract Public key send from server and GID from Received MSG1 </h3>
                <p>Client Received MSG1: <span id="A_RECEIVED MSG1" class="ciphertext"></span> </p>
                <p>RECEIVED ga_x: <span id="C_RECEIVED_ga_x" class="ciphertext"></span> </p>
                <p>RECEIVED ga_y: <span id="C_RECEIVED_ga_y" class="ciphertext"></span> </p>
                <p>RECEIVED GID: <span id="C_RECEIVED_GID" class="ciphertext"></span> </p>
                <h3>Construct MSG2 </h3>
                <p>Client Public Key: <span id="C_ECCDH_public_key" class="ciphertext"></span>
                </p>
                <p>Client Private Key: <span id="C_ECCDH_private_key" class="ciphertext"></span>
                </p>
                <p>Client Shared_key: <span id="C_ECCDH_shared_key" class="ciphertext"></span> </p>
                <p>Client derived smk_key: <span id="C_ECCDH_derived_smk_key" class="ciphertext"></span> </p>
                <p>Client derived sk_key: <span id="C_ECCDH_derived_sk_key" class="ciphertext"></span> </p>
                <p>Client derived mk_key: <span id="C_ECCDH_derived_mk_key" class="ciphertext"></span> </p>
                <p>Client derived vk_key: <span id="C_ECCDH_derived_vk_key" class="ciphertext"></span> </p>

            </div>
        </div>

        <h3>Acknowledgements</h3> A large part of the work on the jspaillier library was done at <a href="http://www.tno.nl">TNO</a> in a project supported by the <a href="http://www.commit-nl.nl">COMMIT</a> program.
    </div>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
    <script src="js/bootstrap.min.js"></script>

    <!-- add AES-CMAC -->
    <script type="text/javascript" src="cryptojs-extension-master/lib/cryptojs-aes.min.js"></script>
    <script type="text/javascript" src="cryptojs-extension-master/build/cmac.min.js"></script>
    <!-- test web crypto  -->
    <script type="text/javascript" src="js/webcrypto.js"></script>
    <!-- end of web crypto -->

    <script type="text/javascript">
        $(function() {

            //Client
            $('#A_btn_start_Attestation').click(function(event) {

                // received from msg1
                var C_RECEIVED_ga_x;
                var A_RECEIVED_ga_y;
                var C_RECEIVED_GID;

                // generated key pair
                var C_private_key_object;
                var C_public_key_object;

                // shared key generated by ga_x, C_private_key_object
                var dh_shared_key; // bits

                var C_smk_key; // padding 0
                var C_mk_key; // padding 2
                var C_sk_key; // padding 1
                var C_vk_key; // padding 3

                var ga; // received from msg1
                var gb; // generated by client

                var C_privateKey = "018c03d1533457adeaaeb6653b6a861fec879c4311de663bcea1522dbb6ce790"; // big-endiness
                var C_privateKey_x = "72128a7a17526ebf85d03a623730aead3e3daaee9c60731db05be8621c4beb38"; // little-endiness
                var C_privateKey_y = "d48140d950e2577b26eeb741e7c614e224b7bdc903f29a28a83cc81011145e06"; // little-endienss

                console.log("click start attestation button");
                var msg1_request_data = {
                    'username': "user1",
                    'password': "13313",
                    'SSL': "nSSL",
                    // 'privateKey': "018c03d1533457adeaaeb6653b6a861fec879c4311de663bcea1522dbb6ce790"
                };
                $.ajax({
                    type: "POST",
                    url: "get_MSG1.php",
                    data: msg1_request_data,
                    dataType: "JSON",
                    success: function(text) {

                        console.log(text);

                        C_RECEIVED_ga_x = text['ga_x'];
                        C_RECEIVED_ga_y = text['ga_y'];

                        //test
                        C_RECEIVED_ga_x = changeEndian("955b685a1aa2aa26632745aa5cebeb6d54e82b382276bf856f74767dfe6c3abe");
                        C_RECEIVED_ga_y = changeEndian("1c2ac3b5122a502caf32d27d5ed2fc764c9d4b398f9ceabb4014839416297ff3");
                        //end of test

                        C_RECEIVED_GID = text['GID'];

                        // ga is transformed to big-endiness before server sent because webcyrot accpt big-endienss

                        ga = new Uint8Array(64);
                        ga.set(hexStringToByte(C_RECEIVED_ga_x), 0);
                        ga.set(hexStringToByte(C_RECEIVED_ga_y), hexStringToByte(C_RECEIVED_ga_x).byteLength);

                        $('#C_RECEIVED_ga_x').html(C_RECEIVED_ga_x);
                        $('#C_RECEIVED_ga_y').html(C_RECEIVED_ga_y);
                        $('#C_RECEIVED_GID').html(C_RECEIVED_GID);

                        // then generating MSG2 keys
                        window.crypto = window.crypto || window.msCrypto; //for IE11
                        if (window.crypto.webkitSubtle) {
                            window.crypto.subtle = window.crypto.webkitSubtle; //for Safari
                        }
                        if (window.crypto.subtle) {

                            var gb_x = "98370bbd2b9ad2e890bd2b1016310cd5c396c5a41478779db947904ae7cf142f";
                            var gb_y = "88ccfea8fee2883b05d45238c227729818fda47646654bd8b243756d96137f6a";
                            var gb_d = "b92bd50aa1e30bfdaa3ea2aa0fca94ab631fb3aff09cd5f4bbf8d53ede750d5b";

                            window.crypto.subtle.importKey(
                                    "jwk", //can be "jwk" (public or private), "raw" (public only), "spki" (public only), or "pkcs8" (private only)
                                    { //this is an example jwk key, other key types are Uint8Array objects
                                        kty: "EC",
                                        crv: "P-256",
                                        x: HEX2Base64URL(changeEndian(gb_x)),
                                        y: HEX2Base64URL(changeEndian(gb_y)),
                                        d: HEX2Base64URL(changeEndian(gb_d)),
                                        ext: true,
                                    }, { //these are the algorithm options
                                        name: "ECDH",
                                        namedCurve: "P-256", //can be "P-256", "P-384", or "P-521"
                                    },
                                    false, //whether the key is extractable (i.e. can be used in exportKey)
                                    ["deriveKey", "deriveBits"] //"deriveKey" and/or "deriveBits" for private keys only (just put an empty list if importing a public key)
                                )
                                .then(function(privateKey) {
                                    console.log("improted private key is");
                                    imported_private_key = privateKey;
                                    console.log(privateKey)
                                    console.log(C_RECEIVED_ga_x);
                                    console.log(C_RECEIVED_ga_y);

                                    window.crypto.subtle.importKey(
                                            "jwk", //can be "jwk" (public or private), "raw" (public only), "spki" (public only), or "pkcs8" (private only)
                                            { //this is an example jwk key, other key types are Uint8Array objects
                                                kty: "EC",
                                                crv: "P-256",
                                                x: HEX2Base64URL(C_RECEIVED_ga_x),
                                                y: HEX2Base64URL(C_RECEIVED_ga_y),
                                                // d: "250dDOHq0N-P7fevM9XBfQ9fpICqDgnYk2vX0w8Ci-c",
                                                ext: true,
                                            }, { //these are the algorithm options
                                                name: "ECDH",
                                                namedCurve: "P-256", //can be "P-256", "P-384", or "P-521"
                                            },
                                            false, //whether the key is extractable (i.e. can be used in exportKey)
                                            [] //"deriveKey" and/or "deriveBits" for private keys only (just put an empty list if importing a public key)
                                        )
                                        .then(function(publicKey) {
                                            //returns a privateKey (or publicKey if you are importing a public key)
                                            console.log("improted public key is");
                                            console.log(publicKey);

                                            window.crypto.subtle.deriveBits({
                                                        name: "ECDH",
                                                        namedCurve: "P-256", //can be "P-256", "P-384", or "P-521"
                                                        public: publicKey, //an ECDH public key from generateKey or importKey
                                                    },
                                                    imported_private_key, //your ECDH private key from generateKey or importKey
                                                    256)
                                                .then(function(bits) { // it's still the big-endiness format

                                                    console.log("it should be 67037ff5c47c93acccb4b3d0bca7662f436f3ef2393608b3d7bf2c114194c611")
                                                    console.log("derived shared key is:");
                                                    dh_shared_key = new Uint8Array(bits);
                                                    console.log(changeEndian(byteToHexString(dh_shared_key))); 


                                                }).catch = function(e) {
                                                    console.log("derived shared key error");
                                                    console.log(e.message);
                                                }
                                        })
                                        .catch(function(e) {
                                            console.log("import public key error")
                                            console.error(e);
                                        });



                                })
                                .catch = function(e) {
                                    console.log("import private key error");
                                    console.log(e.message);
                                }



                        } else {
                            alert("Cryptography API not Supported");
                        }

                    },
                    error: function(xhr, textStatus, errorThrown) {
                        console.log('ajax loading error...');
                        return false;
                    }
                });

            }); // end of Client

        });
    </script>
</body>

</html>